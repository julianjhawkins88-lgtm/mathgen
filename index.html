<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mathe Ã¼ben</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, sans-serif; background: #f5f5f5; padding: 12px; }
    .card { max-width: 420px; margin: 0 auto; background: #fff; border-radius: 12px; padding: 20px; }
    h1 { font-size: 1.3rem; text-align: center; margin-bottom: 16px; }
    .grades { display: flex; gap: 6px; margin-bottom: 16px; }
    .grades button { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px; background: #fff; cursor: pointer; font-weight: 600; }
    .grades button.on { background: #4a7ddb; color: #fff; border-color: #4a7ddb; }
    .task { background: #fffaf0; border: 1px solid #e8dcc8; border-radius: 8px; padding: 20px; text-align: center; margin-bottom: 12px; }
    .task-text { font-size: 1.6rem; font-weight: 700; }
    .answers { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 12px; }
    .answers button { padding: 14px; border: 1px solid #ddd; border-radius: 6px; background: #fff; font-size: 1.2rem; font-weight: 600; cursor: pointer; }
    .answers button.ok { background: #4caf82; color: #fff; border-color: #4caf82; }
    .answers button.no { background: #e57373; color: #fff; border-color: #e57373; }
    .msg { text-align: center; padding: 10px; border-radius: 6px; margin-bottom: 12px; font-weight: 600; background: #f0f0f0; }
    .msg.ok { background: #e8f5ee; color: #2d6a4f; }
    .msg.no { background: #ffebee; color: #c53030; }
    .btns { display: flex; gap: 6px; }
    .btns button { flex: 1; padding: 12px; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; }
    .btns .main { background: #4a7ddb; color: #fff; }
    .btns .help { background: #9c27b0; color: #fff; }
    .btns .help:disabled { opacity: 0.4; }
    .btns .snd { background: #eee; width: 44px; flex: none; }
    
    /* Modal */
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); display: none; align-items: center; justify-content: center; padding: 12px; }
    .overlay.show { display: flex; }
    .modal { background: #fff; border-radius: 12px; max-width: 440px; width: 100%; max-height: 90vh; overflow-y: auto; }
    .modal-head { background: #9c27b0; color: #fff; padding: 12px 16px; font-weight: 700; display: flex; justify-content: space-between; border-radius: 12px 12px 0 0; }
    .modal-head button { background: none; border: none; color: #fff; font-size: 1.2rem; cursor: pointer; }
    .modal-body { padding: 16px; }
    .solved { background: #fffaf0; border: 1px solid #e8dcc8; border-radius: 6px; padding: 12px; text-align: center; font-size: 1.3rem; font-weight: 700; margin-bottom: 12px; }
    .viz { background: #f8f8f8; border-radius: 6px; padding: 12px; margin-bottom: 12px; overflow-x: auto; }
    .viz-label { font-size: 0.75rem; font-weight: 700; color: #666; margin-bottom: 8px; text-transform: uppercase; }
    .steps { border-left: 3px solid #9c27b0; padding: 8px 12px; background: #faf8fc; border-radius: 0 6px 6px 0; }
    .steps b { display: block; margin-bottom: 4px; }
    .steps ol { margin: 0; padding-left: 18px; line-height: 1.6; }
    .modal-foot { padding: 12px 16px; text-align: center; }
    .modal-foot button { background: #4a7ddb; color: #fff; border: none; border-radius: 6px; padding: 10px 24px; font-weight: 700; cursor: pointer; }
  </style>
</head>
<body>
<div class="card">
  <h1>Mathe Ã¼ben</h1>
  <div class="grades" id="grades">
    <button class="on" data-g="1">Kl. 1</button>
    <button data-g="2">Kl. 2</button>
    <button data-g="3">Kl. 3</button>
    <button data-g="4">Kl. 4</button>
  </div>
  <div class="task"><div class="task-text" id="task">â€“</div></div>
  <div class="answers" id="ans"></div>
  <div class="msg" id="msg">DrÃ¼cke "Start"</div>
  <div class="btns">
    <button class="snd" id="snd">ðŸ”Š</button>
    <button class="help" id="help" disabled>ðŸ’¡</button>
    <button class="main" id="start">Start</button>
  </div>
</div>

<div class="overlay" id="ov">
  <div class="modal">
    <div class="modal-head"><span>ErklÃ¤rung</span><button id="cls">âœ•</button></div>
    <div class="modal-body" id="mbody"></div>
    <div class="modal-foot"><button id="mok">OK</button></div>
  </div>
</div>

<script>
const SK = {
  1: [{t:'add',m:10},{t:'add',m:20},{t:'sub',m:10},{t:'sub',m:20}],
  2: [{t:'add',m:100},{t:'sub',m:100},{t:'mul',m:5}],
  3: [{t:'mul',m:10},{t:'div',m:10}],
  4: [{t:'mul',m:12},{t:'div',m:12}]
};

const rnd = (a,b) => Math.floor(Math.random()*(b-a+1))+a;
const pick = a => a[rnd(0,a.length-1)];

function opts(c) {
  const s = new Set([c]);
  while(s.size<4) { let n=c+pick([-2,-1,1,2,3]); if(n<0)n=-n; s.add(n); }
  const arr = [...s].sort(()=>Math.random()-0.5);
  return {o:arr.map(String), ci:arr.indexOf(c)};
}

const G = {
  add: m => { const a=rnd(0,m),b=rnd(0,m-a),r=a+b; const{o,ci}=opts(r); return{p:`${a} + ${b} = ?`,o,ci,d:{a,b,r,op:'add'}}; },
  sub: m => { const a=rnd(0,m),b=rnd(0,a),r=a-b; const{o,ci}=opts(r); return{p:`${a} âˆ’ ${b} = ?`,o,ci,d:{a,b,r,op:'sub'}}; },
  mul: m => { const a=rnd(1,m),b=rnd(1,m),r=a*b; const{o,ci}=opts(r); return{p:`${a} Ã— ${b} = ?`,o,ci,d:{a,b,r,op:'mul'}}; },
  div: m => { const b=rnd(1,m),r=rnd(1,m),a=b*r; const{o,ci}=opts(r); return{p:`${a} Ã· ${b} = ?`,o,ci,d:{a,b,r,op:'div'}}; }
};

function make(g) { const s=pick(SK[g]); return G[s.t](s.m); }

// SVG Visualisierungen (minimal)
function numLine(a,b,r,op) {
  const max=Math.max(a,r)+2, w=Math.min(400,max*22), pad=25, y=40, sc=(w-2*pad)/max, x=n=>pad+n*sc;
  let s=`<svg width="${w}" height="70" style="display:block">`;
  s+=`<line x1="${pad}" y1="${y}" x2="${w-pad}" y2="${y}" stroke="#bbb" stroke-width="2"/>`;
  for(let i=0;i<=max;i+=max>20?5:1) s+=`<line x1="${x(i)}" y1="${y-4}" x2="${x(i)}" y2="${y+4}" stroke="#999"/>`;
  s+=`<circle cx="${x(a)}" cy="${y}" r="5" fill="#4a7ddb"/><text x="${x(a)}" y="${y-10}" text-anchor="middle" font-size="11" fill="#4a7ddb">${a}</text>`;
  const col=op==='add'?'#4caf82':'#e57373', mid=(x(a)+x(r))/2;
  s+=`<path d="M${x(a)} ${y-6} Q${mid} ${y-28} ${x(r)} ${y-6}" fill="none" stroke="${col}" stroke-width="2"/>`;
  s+=`<text x="${mid}" y="${y-30}" text-anchor="middle" font-size="11" fill="${col}">${op==='add'?'+':'âˆ’'}${b}</text>`;
  s+=`<circle cx="${x(r)}" cy="${y}" r="6" fill="#9c27b0"/><text x="${x(r)}" y="${y+18}" text-anchor="middle" font-size="11" font-weight="700" fill="#9c27b0">=${r}</text>`;
  return s+'</svg>';
}

function coord(a,b,r,op) {
  // Koordinatensystem mit Gerade: y = aÂ·x (Multiplikation) oder y = x/b (Division)
  const xMax = b + 2;
  const yMax = (op==='mul' ? r : r) + 2;
  const pad = 32, w = 180, h = 150;
  const xSc = (w - pad - 10) / xMax;
  const ySc = (h - pad - 10) / yMax;
  const toX = v => pad + v * xSc;
  const toY = v => h - pad - v * ySc;
  
  let s = `<svg width="${w}" height="${h}" style="display:block">`;
  
  // Achsen
  s += `<line x1="${pad}" y1="${h-pad}" x2="${w-5}" y2="${h-pad}" stroke="#333" stroke-width="1.5"/>`;
  s += `<line x1="${pad}" y1="${h-pad}" x2="${pad}" y2="8" stroke="#333" stroke-width="1.5"/>`;
  s += `<polygon points="${w-5},${h-pad} ${w-11},${h-pad-3} ${w-11},${h-pad+3}" fill="#333"/>`;
  s += `<polygon points="${pad},8 ${pad-3},14 ${pad+3},14" fill="#333"/>`;
  s += `<text x="${w-8}" y="${h-pad+13}" font-size="10" fill="#333">x</text>`;
  s += `<text x="${pad-10}" y="14" font-size="10" fill="#333">y</text>`;
  
  // Ticks
  for (let i = 1; i <= xMax; i++) s += `<line x1="${toX(i)}" y1="${h-pad}" x2="${toX(i)}" y2="${h-pad+3}" stroke="#888"/>`;
  for (let i = 1; i <= yMax; i++) s += `<line x1="${pad-3}" y1="${toY(i)}" x2="${pad}" y2="${toY(i)}" stroke="#888"/>`;
  s += `<text x="${pad-6}" y="${h-pad+12}" font-size="9" fill="#666">0</text>`;
  
  // Gerade vom Ursprung zum Punkt (b, r)
  s += `<line x1="${toX(0)}" y1="${toY(0)}" x2="${toX(b)}" y2="${toY(r)}" stroke="#4a7ddb" stroke-width="2"/>`;
  
  // Gestrichelte Hilfslinien
  s += `<line x1="${toX(b)}" y1="${h-pad}" x2="${toX(b)}" y2="${toY(r)}" stroke="#999" stroke-dasharray="3,2"/>`;
  s += `<line x1="${pad}" y1="${toY(r)}" x2="${toX(b)}" y2="${toY(r)}" stroke="#999" stroke-dasharray="3,2"/>`;
  
  // Punkt
  s += `<circle cx="${toX(b)}" cy="${toY(r)}" r="5" fill="#9c27b0"/>`;
  
  // Beschriftungen an den Achsen
  s += `<text x="${toX(b)}" y="${h-pad+13}" text-anchor="middle" font-size="10" font-weight="700" fill="#4a7ddb">${b}</text>`;
  s += `<text x="${pad-6}" y="${toY(r)+4}" text-anchor="end" font-size="10" font-weight="700" fill="#9c27b0">${r}</text>`;
  
  // Punkt-Koordinaten
  s += `<text x="${toX(b)+6}" y="${toY(r)-6}" font-size="10" font-weight="700" fill="#9c27b0">(${b}|${r})</text>`;
  
  return s + '</svg>';
}

function explain(t) {
  const{a,b,r,op}=t.d;
  let viz='', st=[], label='';
  if(op==='add') { viz=numLine(a,b,r,'add'); label='Zahlenstrahl'; st=[`Bei ${a} starten`,`${b} nach rechts`,`Ergebnis: ${r}`]; }
  else if(op==='sub') { viz=numLine(a,b,r,'sub'); label='Zahlenstrahl'; st=[`Bei ${a} starten`,`${b} nach links`,`Ergebnis: ${r}`]; }
  else if(op==='mul') { viz=coord(a,b,r,'mul'); label='Koordinatensystem'; st=[`x = ${b}`,`y = ${a} Ã— ${b}`,`Punkt: (${b}|${r})`]; }
  else if(op==='div') { viz=coord(a,b,r,'div'); label='Koordinatensystem'; st=[`${a} Ã· ${b}`,`x = ${b}, y = ?`,`Punkt: (${b}|${r})`]; }
  return `<div class="solved">${t.p.replace('?',r)}</div><div class="viz"><div class="viz-label">${label}</div>${viz}</div><div class="steps"><b>Rechenweg:</b><ol>${st.map(x=>`<li>${x}</li>`).join('')}</ol></div>`;
}

// State & UI
let gr=1, cur=null, done=false, snd=true, voice=null;
const $=id=>document.getElementById(id);

function say(t) {
  if(!snd||!speechSynthesis) return;
  speechSynthesis.cancel();
  const u=new SpeechSynthesisUtterance(t); u.lang='de-DE'; u.rate=0.85;
  if(voice) u.voice=voice;
  speechSynthesis.speak(u);
}
speechSynthesis.onvoiceschanged=()=>{ voice=speechSynthesis.getVoices().find(v=>v.lang.startsWith('de'))||null; };

$('grades').onclick=e=>{
  const b=e.target.closest('button[data-g]'); if(!b) return;
  gr=+b.dataset.g;
  $('grades').querySelectorAll('button').forEach(x=>x.classList.remove('on'));
  b.classList.add('on');
};

$('start').onclick=()=>{
  cur=make(gr); done=false;
  $('task').textContent=cur.p;
  $('msg').className='msg'; $('msg').textContent='WÃ¤hle';
  $('help').disabled=false;
  $('ans').innerHTML='';
  cur.o.forEach((o,i)=>{
    const b=document.createElement('button'); b.textContent=o;
    b.onclick=()=>answer(i);
    $('ans').appendChild(b);
  });
  say(cur.p.replace(/\+/g,' plus ').replace(/âˆ’/g,' minus ').replace(/Ã—/g,' mal ').replace(/Ã·/g,' geteilt durch ').replace(/\?/g,''));
};

function answer(i) {
  if(done) return; done=true;
  const btns=$('ans').querySelectorAll('button');
  btns[cur.ci].classList.add('ok');
  if(i===cur.ci) { $('msg').className='msg ok'; $('msg').textContent='Richtig!'; say('Richtig'); }
  else { btns[i].classList.add('no'); $('msg').className='msg no'; $('msg').textContent='Falsch'; say('Falsch'); }
}

$('help').onclick=()=>{ if(!cur) return; $('mbody').innerHTML=explain(cur); $('ov').classList.add('show'); };
$('cls').onclick=$('mok').onclick=()=>$('ov').classList.remove('show');
$('ov').onclick=e=>{ if(e.target===$('ov')) $('ov').classList.remove('show'); };
$('snd').onclick=()=>{ snd=!snd; $('snd').textContent=snd?'ðŸ”Š':'ðŸ”‡'; };

document.onkeydown=e=>{
  if(e.key==='Escape') $('ov').classList.remove('show');
  if($('ov').classList.contains('show')) return;
  if(e.key==='Enter') $('start').click();
  if(e.key==='e'&&cur) $('help').click();
  if('1234'.includes(e.key)){ const b=$('ans').querySelectorAll('button')[+e.key-1]; if(b) b.click(); }
};
</script>
</body>
</html>
